name: OSVVM Regression Testing on GHDL

on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 15 * * *'

jobs:
  RegressionTest:
    name: ${{ matrix.os.icon }}${{ matrix.os.name }} - GHDL ${{ matrix.backend }}
    runs-on: ${{ matrix.os.image }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - {icon: "🐧",   name: "Ubuntu",  image: "ubuntu-24.04", shell: "bash",      runtime: ""}
          - {icon: "🍏",   name: "macOS",   image: "macos-14",     shell: "bash",      runtime: ""}
          - {icon: "🪟🟨", name: "Windows", image: "windows-2022", shell: "msys2 {0}", runtime: "ucrt64"}
        backend:
          - mcode
          - llvm
        exclude:
          - {os: {name: "macOS"}, backend: "mcode"}

    defaults:
      run:
        shell: ${{ matrix.os.shell }}

    steps:
      - name: ⏬ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ${{ matrix.os.icon }} Setup MSYS2 for ${{ matrix.os.runtime }}
        if: runner.os == 'Windows' && matrix.os.runtime != ''
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.os.runtime }}
          update: true
          install: git
          pacboy: tcl:p tcllib:p

      - name: ⚙️ Setup GHDL
        uses: ghdl/setup-ghdl@v1
        with:
          version: nightly
          runtime: ${{ matrix.os.runtime }}
          backend: ${{ matrix.backend }}

      - name: 🐧🛠️ Install tcl and tcllib
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends tcl tcllib

#      - name: 🍏🛠️ Install tcl-tk
#        if: runner.os == 'macOS'
#        run: |
#          brew install tcl-tk

      - name: 🚧 Run tests'
        run: |
          mkdir temp
          cd temp

          tclsh ../.github/test.tcl

      - name: '📤 Upload artifact: logs'
        uses: actions/upload-artifact@v4
        with:
          name: log-ubuntu-ghdl-${{ matrix.backend }}
          include-hidden-files: true
          path: |
            temp/*.log
            temp/*.html
            temp/reports/*.html
            temp/reports/**/*.html
            temp/logs/**/*.*
            temp/reports/*.css
            temp/reports/osvvm.png
          if-no-files-found: error

      - name: '📤 Upload artifact: yaml'
        uses: actions/upload-artifact@v4
        with:
          name: yaml-ubuntu-ghdl-${{ matrix.backend }}
          include-hidden-files: true
          path: |
            temp/*.yml
          if-no-files-found: error

      - name: '📤 Upload artifact: xml'
        uses: actions/upload-artifact@v4
        with:
          name: xml-ubuntu-ghdl-${{ matrix.backend }}
          include-hidden-files: true
          path: |
            temp/*.xml
          if-no-files-found: error

  PublishTestResults:
    name: 📊 Publish Unit Tests Results
    runs-on: ubuntu-24.04
    needs:
      - RegressionTest

    if: always()

    steps:
#      - name: ⏬ Checkout repository
#        uses: actions/checkout@v4

      - name: '📥 Download artifact: package'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: log-*
          
      - name: List all artifacts
        run: |
          tree artifacts

      - name: 📊 Publish Unit Test Results
        uses: dorny/test-reporter@v1
        with:
          name: OSVVM VC Regression Results
          path: artifacts/**/*.xml
          reporter: java-junit
          list-suites: all
          list-tests: failed

  Package:
    name: Package OSVVMLibraries incl. all Git submodules as artifact
    runs-on: ubuntu-24.04

    steps:
      - name: ⏬ Checkout repository
        uses: actions/checkout@v4
        with:
          path: OsvvmLibraries

      - name: List content of 'OsvvmLibraries' ...
        run: |
          tree OsvvmLibraries

      - name: '📤 Upload artifact: osvvm'
        uses: actions/upload-artifact@v4
        with:
          name: osvvm
          path: |
            OsvvmLibraries/*
          if-no-files-found: error
